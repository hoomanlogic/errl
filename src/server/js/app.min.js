var app=app||{};if(function(e,t){"use strict";e.HOST_NAME=window.location.href.split("/").slice(0,3).join("/"),errl.config={developer:"hoomanlogic",key:"54263eb4-6ced-49bf-9bd7-14f0106c2a02",product:"Errl",environment:null,version:"1.0.0",getState:null,getUser:function(){return"geoffrey.floyd"},onLogged:function(e){toastr.error('<p><string>Oops!</strong></p><p>We\'re really sorry about that.</p><p>We\'ll get this fixed as soon as possible.</p><a class="btn btn-default btn-link" target="_blank" href="'+errl.getErrorDetailUrl(e.errorId)+'">Show me details</a> ')}},e.setAccessToken=function(e){sessionStorage.setItem("accessToken",e)},e.getAccessToken=function(){return sessionStorage.getItem("accessToken")},e.hideCriteria=function(){t("#criteria").removeClass("expanded"),t("#view").removeClass("with-criteria")},e.showCriteria=function(){t("#criteria").addClass("expanded"),t("#view").addClass("with-criteria")}}(app,$),window.onerror=function(){errl.log(arguments)},!app.getAccessToken()){var fragment=hl.common.getFragment();fragment.access_token?(window.location.hash=fragment.state||"",app.setAccessToken(fragment.access_token)):window.location="/Account/Authorize?client_id=web&response_type=token&state="+encodeURIComponent(window.location.hash)}window.onmousemove=function(e){e.y>50&&e.x<20&&!$("#criteria").hasClass("expanded")?app.showCriteria():e.y>50&&e.x>420&&$("#criteria").hasClass("expanded")&&app.hideCriteria()};var ContentEditable=React.createClass({displayName:"ContentEditable",render:function(){return React.createElement("div",{style:{display:"inline"},onInput:this.emitChange,onBlur:this.emitChange,contentEditable:!0,dangerouslySetInnerHTML:{__html:this.props.html}})},shouldComponentUpdate:function(e){return e.html!==this.props.html},emitChange:function(){var e=this.getDOMNode().innerHTML;this.props.onChange&&e!==this.lastHtml&&this.props.onChange({target:{value:e}}),this.lastHtml=e}}),DataTable=React.createClass({displayName:"DataTable",getInitialState:function(){return{sortBy:this.props.sortBy||this.props.columnDefinitions[0].field,sortAsc:void 0!==this.props.sortAsc?this.props.sortAsc:!0}},componentDidUpdate:function(){$('[data-toggle="tooltip"]').tooltip()},render:function(){var e=this.state.sortBy,t=this.state.sortAsc,r=this.props.columnDefinitions,a=_.sortBy(this.props.data,function(t){return t[e]});if(t!==!0&&a.reverse(),!r)return null;var i,n,s=[],o=[];for(i=0;i<r.length;i++){var l=React.createElement("th",{className:"text-"+(r[i].justify||"left")},React.createElement("a",{href:"javascript:;",onClick:this.sort.bind(null,r[i].field)},r[i].display," ",React.createElement("i",{className:e===r[i].field?t?"fa fa-sort-asc":"fa fa-sort-desc":""})));s.push(l)}if(a)for(n=0;n<a.length;n++){var c=[];for(i=0;i<r.length;i++){var d=null,m=a[n][r[i].field];r[i].limitLength&&m.length>r[i].limitLength&&(m=m.slice(0,r[i].limitLength)),d=r[i].onRender?r[i].onRender(a[n],r[i].field,n):r[i].onCellClick?React.createElement("a",{href:"javascript:;",onClick:r[i].onCellClick.bind(null,r[i].field,a[n])},React.createElement("span",{"data-toggle":"tooltip","data-placement":"bottom",title:a[n][r[i].field]},m)):React.createElement("span",{"data-toggle":"tooltip","data-placement":"bottom",title:a[n][r[i].field]},m);var u=React.createElement("td",{className:"text-"+(r[i].justify||"left")},d);c.push(u)}var p=React.createElement("tr",null,c);o.push(p)}return React.createElement("table",{className:"table table-striped"},React.createElement("thead",null,React.createElement("tr",null,s)),React.createElement("tbody",null,o))},sort:function(e){var t=this.state.sortBy,r=this.state.sortAsc;e===t?r=!r:(t=e,r=!0),this.setState({sortBy:t,sortAsc:r})}}),DropdownMenu=React.createClass({displayName:"DropdownMenu",getDefaultProps:function(){return{className:"",style:null,buttonContent:null,menuItems:[],open:!1}},render:function(){var e=this.props.className,t=this.props.buttonContent,r=this.props.style,a=this.props.menuItems;return e.length>0&&(e=" "+e),React.createElement("li",{ref:"dropdown",className:"dropdown"+e,onClick:this.toggle},React.createElement("a",{href:"#","data-toggle":"dropdown",className:"dropdown-toggle",style:r},t),React.createElement("ul",{className:"dropdown-menu"},a))},toggle:function(){var e=$(window),t=$(this.refs.dropdown.getDOMNode()),r=function(a){0!=t.has(a.target).length||t.is(a.target)||(t.removeClass("open"),e.off("click.Bst",r))};t.toggleClass("open"),e.on("click.Bst",r)}}),Modal=React.createClass({displayName:"Modal",getDefaultProps:function(){return{backdrop:!0,buttons:[],keyboard:!0,show:!0,remote:""}},render:function(){var e=this.props.buttons.map(function(e,t){return React.createElement("button",{key:t,type:"button",className:"btn btn-"+e.type,onClick:e.handler},e.text)});return React.createElement("div",{className:"modal fade"},React.createElement("div",{className:"modal-dialog"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},this.renderCloseButton(),React.createElement("strong",null,this.props.header)),React.createElement("div",{className:"modal-body scroll"},this.props.children),React.createElement("div",{className:"modal-footer"},e))))},renderCloseButton:function(){return React.createElement("button",{type:"button",className:"close",onClick:this.hide,dangerouslySetInnerHTML:{__html:"&times"}})},hide:function(){var e=$(this.getDOMNode());e.removeClass("in"),window.setTimeout(function(){e.css("display","none")},150)},show:function(){var e=$(this.getDOMNode());e.css("display","block"),window.setTimeout(function(){e.addClass("in")},1)}}),Panel=React.createClass({displayName:"Panel",getDefaultProps:function(){return{header:null,type:"default"}},componentDidMount:function(){this.rememberHeight()},componentDidUpdate:function(){this.rememberHeight()},render:function(){var e=this.props.children,t=this.props.type,r=this.props.header;return React.createElement("div",{className:"panel panel-"+t},React.createElement("div",{className:"panel-heading clickable",onClick:this.toggle},React.createElement("h4",{className:"panel-title overflow"},r)),React.createElement("div",{ref:"collapsible",className:"panel-collapse collapse"},e))},rememberHeight:function(){var e=$(this.refs.collapsible.getDOMNode());this.props.height=e.height()},toggle:function(){var e=$(this.refs.collapsible.getDOMNode());e.hasClass("collapsing")||(e.hasClass("in")?(e.css("height",this.props.height+"px").removeClass("collapse in").addClass("collapsing").attr("aria-expanded",!1).height(0).css("height","0"),window.setTimeout(function(){e.removeClass("collapsing").addClass("collapse")},350)):(e.css("height","0").removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).height(0).css("height",this.props.height+"px"),window.setTimeout(function(){e.removeClass("collapsing").addClass("collapse in").height("").css("height",null)},350)))}}),ErrorHistoryModal=React.createClass({displayName:"ErrorHistoryModal",getInitialState:function(){return{details:null,info:null}},render:function(){var e=null;return this.state.info&&(e=this.state.info.map(function(e){return React.createElement("li",null,e)})),React.createElement(Modal,{ref:"modal",show:!1,header:"Error History"},React.createElement("div",null,React.createElement("ul",{id:"modalStatsInfo"},e),React.createElement(DataTable,{sortBy:"occurred",sortAsc:!1,data:this.state.details,columnDefinitions:[{field:"errorType",display:"Type"},{field:"errorDescription",display:"Description"},{field:"objectName",display:"Object"},{field:"subName",display:"Sub"},{field:"stackTrace",display:"Stack Trace",onRender:this.renderStackTrace},{field:"state",display:"State",onRender:this.renderJsonTree},{field:"details",display:"Details",onRender:this.renderJsonTree},{field:"userId",display:"User"},{field:"occurred",display:"Occurred",justify:"right"}]})))},renderStackTrace:function(e){var t=/\((.*?):(\d+):(\d+)\)/;return e.stackTrace.split(" at ").slice(1).map(function(e){console.log(e);var r=t.exec(e);if(null!=r){var a=e.replace(r[0],"").trim();return React.createElement("div",null,React.createElement("a",{target:"_blank",href:r[1]},React.createElement("span",{"data-toggle":"tooltip","data-placement":"right",title:r[0]},a)))}return React.createElement("div",null,e)})},renderJsonTree:function(e,t){return e[t].split(",").map(function(e){return React.createElement("div",null,e)})},handleClose:function(){this.refs.modal.hide()},open:function(e){this.setState({details:e.details,info:e.info}),this.refs.modal.show()}}),StatusPage=React.createClass({displayName:"StatusPage",getInitialState:function(){return{options:null,criteria_product:null,criteria_environment:null,criteria_version:null,criteria_from:null,criteria_to:null,fromOptions:[],toOptions:[],hourlySummaryResult:null,errorSummaryResult:null}},componentDidMount:function(){this.getOptions()},hourlySummaryNeedsCanvasRender:!1,errorSummaryNeedsCanvasRender:!1,componentDidUpdate:function(){this.hourlySummaryNeedsCanvasRender&&(this.paintChart_HourlySummary(),this.hourlySummaryNeedsCanvasRender=!1),this.errorSummaryNeedsCanvasRender&&(this.paintChart_ErrorSummary(),this.errorSummaryNeedsCanvasRender=!1)},render:function(){var e=this.state.options,t=this.state.hourlySummaryResult,r=this.state.errorSummaryResult;if(null===e)return null;var a=this.getProducts(e).map(function(e){return React.createElement("option",{value:e},e)}),i=this.getEnvironments(e,this.state.criteria_product).map(function(e){return React.createElement("option",{value:e},e)}),n=this.getVersions(e,this.state.criteria_product,this.state.criteria_environment).map(function(e){return React.createElement("option",{value:e},e)}),s=this.state.fromOptions.map(function(e){return React.createElement("option",{value:e.value},e.label)}),o=this.state.toOptions.map(function(e){return React.createElement("option",{value:e.value},e.label)}),l=null;t&&(l=React.createElement("div",null,React.createElement("h3",{id:"headingHourly"},"Hourly Summary"),React.createElement("hr",null),React.createElement("div",{id:"myLineChartContainer"},React.createElement("canvas",{id:"myLineChart",width:"970",height:"400"})),React.createElement("div",{id:"myLineChartLegend"})));var c=null;return r&&(c=React.createElement("div",{id:"errorSummarySection"},React.createElement("h3",null,"Error Summary"),React.createElement("hr",null),React.createElement("div",{id:"myPieChartContainer"},React.createElement("canvas",{id:"myPieChart",width:"600",height:"300"})),React.createElement("div",{id:"myPieChartLegend"}),React.createElement(DataTable,{sortBy:"latestOccurrence",sortAsc:!1,data:this.state.errorSummaryResult.details,columnDefinitions:[{field:"errorType",display:"Type",onCellClick:this.openErrorHistory},{field:"errorDescription",display:"Description"},{field:"objectName",display:"Object",onCellClick:this.openErrorHistory},{field:"subName",display:"Sub",onCellClick:this.openErrorHistory},{field:"timesOccurred",display:"# Errors"},{field:"latestOccurrence",display:"Latest"},{field:"usersAffected",display:"Users Affected"}]}))),React.createElement("div",{className:"row"},React.createElement("div",{id:"criteria",className:"expanded"},React.createElement("form",{className:"form-horizontal",role:"form"},React.createElement("div",{className:"form-group"},React.createElement("label",{"for":"selectProduct",className:"col-sm-4 control-label"},"Product"),React.createElement("div",{className:"col-sm-8"},React.createElement("select",{id:"selectProduct",className:"form-control",value:this.state.criteria_product,onChange:this.handleCriteriaChange},a))),React.createElement("div",{className:"form-group"},React.createElement("label",{"for":"selectEnvironment",className:"col-sm-4 control-label"},"Environment"),React.createElement("div",{className:"col-sm-8"},React.createElement("select",{id:"selectEnvironment",className:"form-control",value:this.state.criteria_environment,onChange:this.handleCriteriaChange},i))),React.createElement("div",{className:"form-group"},React.createElement("label",{"for":"selectVersion",className:"col-sm-4 control-label"},"Version"),React.createElement("div",{className:"col-sm-8"},React.createElement("select",{id:"selectVersion",className:"form-control",value:this.state.criteria_version,onChange:this.handleCriteriaChange},n))),React.createElement("div",{className:"form-group"},React.createElement("label",{"for":"selectFrom",className:"col-sm-4 control-label"},"From"),React.createElement("div",{className:"col-sm-8"},React.createElement("select",{id:"selectFrom",className:"form-control",value:this.state.criteria_from,onChange:this.handleCriteriaChange},s))),React.createElement("div",{className:"form-group"},React.createElement("label",{"for":"selectTo",className:"col-sm-4 control-label"},"To"),React.createElement("div",{className:"col-sm-8"},React.createElement("select",{id:"selectTo",className:"form-control",value:this.state.criteria_to,onChange:this.handleCriteriaChange},o))))),React.createElement("div",{id:"view",className:"with-criteria"},l,c),React.createElement(ErrorHistoryModal,{ref:"errorHistoryModal"}))},selectedProductChanged:function(){app.getHourlySummary(),app.refreshOptions("Product")},openErrorHistory:function(e,t){"errorType"===e?this.popupErrorDetails(t.errorType,"",""):"objectName"===e?this.popupErrorDetails("",t.objectName,""):this.popupErrorDetails("",t.objectName,t.subName)},handleCriteriaChange:function(e){var t={errorSummaryResult:null},r=!1;"selectProduct"===e.target.id?(r=!0,t.criteria_product=e.target.value,t.criteria_environment=this.getEnvironments(this.state.options,t.criteria_product)[0],t.criteria_version=this.getVersions(this.state.options,t.criteria_product,t.criteria_environment)[0]):"selectEnvironment"===e.target.id?(r=!0,t.criteria_environment=e.target.value,t.criteria_version=this.getVersions(this.state.options,this.state.criteria_product,t.criteria_environment)[0]):"selectVersion"===e.target.id?(r=!0,t.criteria_version=e.target.value):"selectFrom"===e.target.id?(t.criteria_from=parseInt(e.target.value),t.criteria_from>=this.state.criteria_to&&(t.criteria_to=t.criteria_from+1)):"selectTo"===e.target.id&&(t.criteria_to=parseInt(e.target.value),t.criteria_to<=this.state.criteria_from&&(t.criteria_from=t.criteria_to-1)),r?this.getHourlySummary(t.criteria_product||this.state.criteria_product,t.criteria_environment||this.state.criteria_environment,t.criteria_version||this.state.criteria_version):this.hourlySummaryNeedsCanvasRender=!0,this.setState(t)},getHourlySummary:function(e,t,r){$.ajax({context:this,type:"GET",headers:{Authorization:"Bearer "+app.getAccessToken()},url:app.HOST_NAME+"/api/hourlysummary?product="+encodeURIComponent(e)+"&environment="+encodeURIComponent(t)+"&version="+encodeURIComponent(r)+"&date="}).done(function(e){this.hourlySummaryNeedsCanvasRender=!0;var t=[],r=[],a=null,i=null;if(e.timesOccurred.length>0){var n=0;e.timesOccurred.length>36&&(n=e.timesOccurred.length-36);for(var s=0;s<e.timesOccurred.length;s++)s===n&&(a={value:s,label:e.timesOccurred[s].key}),0===s?t.push({value:s,label:e.timesOccurred[s].key}):s===e.timesOccurred.length-1?(i={value:s,label:e.timesOccurred[s].key},r.push(i)):(t.push({value:s,label:e.timesOccurred[s].key}),r.push({value:s,label:e.timesOccurred[s].key}))}this.setState({hourlySummaryResult:e,fromOptions:t,toOptions:r,criteria_from:a.value,criteria_to:i.value})}).fail(function(e,t){toastr.error(e.responseText||t,"System Error")})},paintChart_HourlySummary:function(){for(var e=[],t=[],r=[],a=[],i=this.state.hourlySummaryResult,n=parseInt(this.state.criteria_from);n<=parseInt(this.state.criteria_to);n++)e.push(i.timesOccurred[n].key),t.push(i.timesOccurred[n].value),r.push(i.procsAffected[n].value),a.push(i.usersAffected[n].value);var i={labels:e,datasets:[{label:"Total errors",fillColor:"rgba(200,200,200,0.2)",strokeColor:"rgba(200,200,200,1)",pointColor:"rgba(200,200,200,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(200,200,200,1)",data:t},{label:"Procedures affected",fillColor:"rgba(151,205,187,0.2)",strokeColor:"rgba(151,205,187,1)",pointColor:"rgba(151,205,187,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,205,187,1)",data:r},{label:"Users affected",fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:a}]};$("#myLineChart").remove(),$("#myLineChartContainer").append('<canvas id="myLineChart" height="400" width="979"><canvas>');var s=$("#myLineChart").get(0).getContext("2d"),o=new Chart(s).Line(i,{scaleFontColor:"rgb(100,100,100)",scaleLineColor:"rgba(60,60,60,0.4)",scaleShowGridLines:!0,scaleGridLineColor:"rgba(80,80,80,.1)",scaleGridLineWidth:1,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span class="badge" style="margin-right: 5px; background-color:<%=datasets[i].strokeColor%>">•</span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'});this.myLineChart=o,$("#myLineChart").click(this.handleLineChartLabelClick),$("#myLineChartLegend").empty(),$("#myLineChartLegend").append(o.generateLegend())},getErrorSummary:function(e,t,r,a,i){$.ajax({context:this,type:"GET",headers:{Authorization:"Bearer "+app.getAccessToken()},url:app.HOST_NAME+"/api/errorsummary?product="+encodeURIComponent(e)+"&environment="+encodeURIComponent(t)+"&version="+encodeURIComponent(r)+"&date="+a+"&hour="+i+"&objectName="}).done(function(e){this.errorSummaryNeedsCanvasRender=!0,this.setState({errorSummaryResult:e})})},paintChart_ErrorSummary:function(){for(var e=this.state.errorSummaryResult,t=[],r=["rgb(247, 70, 74)","rgb(70, 191, 189)","rgb(253, 180, 92)","rgb(121,157,205)","rgb(135, 76, 194)"],a=["rgba(247, 70, 74, 0.7)","rgba(70, 191, 189, 0.7)","rgba(253, 180, 92, 0.7)","rgba(121,157,205,0.7)","rgba(135, 76, 194,0.7)"],i=0;i<e.timesOccurred.length;i++)t.length>4?(t[4].value=t[4].value+e.timesOccurred[i].value,t[4].label=t[4].label+", "+e.timesOccurred[i].key):t.push({value:e.timesOccurred[i].value,color:r[i],highlight:a[i],label:e.timesOccurred[i].key});$("#myPieChart").remove(),$("#myPieChartContainer").append('<canvas id="myPieChart" height="300" width="800"><canvas>');var n=$("#myPieChart").get(0).getContext("2d"),s=new Chart(n).Pie(t,{segmentShowStroke:!0,segmentStrokeColor:"rgb(70,70,70)",segmentStrokeWidth:2,legendTemplate:'<table style="width: 370px" class="<%=name.toLowerCase()%>-legend"><tbody><% for (var i=0; i<segments.length; i++){%><tr><td><span class="badge" style="background-color:<%=segments[i].fillColor%>"><%=segments[i].value%></span></td><td style="padding-left: 5px;"><%if(segments[i].label){%><%=segments[i].label%><%}%></td></tr><%}%></tbody></table>'});$("#myPieChartLegend").empty(),$("#myPieChartLegend").append(s.generateLegend()),$("#errorSummaryTableBody").empty();for(var o=0;o<e.details.length;o++)$("#errorSummaryTableBody").append('<tr><td class="text-right"><a href="javascript:;" onclick="app.popUpErrorHistory(\''+e.details[o].errorType+"',null,null)\">"+e.details[o].errorType+"</a></td><td>"+e.details[o].errorDescription+'</td><td><a href="javascript:;" onclick="app.popUpErrorHistory(null,\''+e.details[o].objectName+"',null)\">"+e.details[o].objectName+'</a></td><td><a href="javascript:;" onclick="app.popUpErrorHistory(null,\''+e.details[o].objectName+"','"+e.details[o].subName+"')\">"+e.details[o].subName+'</td><td class="text-center">'+e.details[o].timesOccurred+'</td><td class="text-right">'+e.details[o].latestOccurrence+'</td><td class="text-center">'+e.details[o].usersAffected+"</td></tr>")},getOptions:function(){$.ajax({context:this,type:"GET",headers:{Authorization:"Bearer "+app.getAccessToken()},url:app.HOST_NAME+"/api/options"}).done(function(e){var t=null,r=null,a=null;if(e&&e.length>0){var t=this.getProducts(e)[0],r=this.getEnvironments(e,t)[0],a=this.getVersions(e,t,r)[0];this.getHourlySummary(t,r,a)}this.setState({options:e,criteria_product:t,criteria_environment:r,criteria_version:a})})},getProducts:function(e){for(var t=[],r=0;r<e.length;r++)-1===t.indexOf(e[r].product)&&t.push(e[r].product);return t},getEnvironments:function(e,t){for(var r=[],a=0;a<e.length;a++)e[a].product===t&&-1===r.indexOf(e[a].environment)&&r.push(e[a].environment);return r},getVersions:function(e,t,r){for(var a=[],i=0;i<e.length;i++)e[i].product===t&&e[i].environment===r&&-1===a.indexOf(e[i].version)&&a.push(e[i].version);return a},handleLineChartLabelClick:function(e){var t=this.myLineChart.getPointsAtEvent(e);0!==t.length&&(this.lastDateClicked=t[0].label.split(" ")[0].replace("/","-").replace("/","-"),this.lastHourClicked=t[0].label.split(" ")[1],this.getErrorSummary(this.state.criteria_product,this.state.criteria_environment,this.state.criteria_version,this.lastDateClicked,this.lastHourClicked))},popupErrorDetails:function(e,t,r){$.ajax({context:this,type:"GET",headers:{Authorization:"Bearer "+app.getAccessToken()},url:app.HOST_NAME+"/api/errorhistory?environment="+encodeURIComponent(this.state.criteria_environment)+"&version=&errorType="+e+"&objectName="+t+"&subName="+r+"&userId="}).done(function(e){this.refs.errorHistoryModal.open(e)})},pollNeedsRefresh:function(){$.ajax({type:"GET",headers:{Authorization:"Bearer "+app.getAccessToken()},url:app.HOST_NAME+"/api/needsrefresh?product="+encodeURIComponent(this.state.criteria_product)+"&environment="+encodeURIComponent(this.state.criteria_environment)+"&version="+encodeURIComponent(this.state.criteria_version)+"&date="+this.state.hourlySummaryResult.latestPoll}).done(function(e){e&&this.getHourlySummary(this.state.criteria_product,this.state.criteria_environment,this.state.criteria_version,!0)})}});